My notes aboout using dtrace for debugging and tracing.



http
----

This script was generated by nhttpsnoop -csg

		#!/usr/sbin/dtrace -Cs

		#pragma D option quiet

		#define MILLISEC (1000)
		#define	MICROSEC (1000 * 1000)
		#define	NANOSEC  (1000 * 1000 * 1000)

		BEGIN
		{
			printf("%-12s %6s %-6s %10s %-6s %-20s\n",
			    "TIME",
			    "PID",
			    "PROBE",
			    "LATENCY",
			    "METHOD",
			    "PATH");
			start = timestamp;
		}

		node*:::http-server-request,
		node*:::http-client-request
		{
			rqstarts[pid, copyinstr(arg2), arg3] = timestamp;
			rqmethods[pid, copyinstr(arg2), arg3] = copyinstr(arg4);
			rqurls[pid, copyinstr(arg2), arg3] = copyinstr(arg5);
		}

		node*:::http-server-response,
		node*:::http-client-response
		/rqstarts[pid, copyinstr(arg1), arg2]/
		{
			printf("[%3d.%06d] %6d %-6s %4d.%-03dms %-6s %-20s\n",
			    (timestamp-start)/NANOSEC,
			    (timestamp-start)%NANOSEC/1000,
			    pid,
			    strtok(probename+sizeof("http-")-1,"-"),
			    (timestamp-rqstarts[pid,copyinstr(arg1),arg2])/MICROSEC,
			    ((timestamp-rqstarts[pid,copyinstr(arg1),arg2])%MICROSEC)/1000,
			    rqmethods[pid,copyinstr(arg1),arg2],
			    strtok(rqurls[pid,copyinstr(arg1),arg2],"?"));

			rqstarts[pid, copyinstr(arg1), arg2] = 0;
			rqmethods[pid, copyinstr(arg1), arg2] = 0;
			rqurls[pid, copyinstr(arg1), arg2] = 0;
		}
		node*:::gc-start
		{
			self->gc_start = timestamp;
		}

		node*:::gc-done
		/self->gc_start/
		{
			printf("[%3d.%06d] %6d %-6s %4d.%-03dms %-6s %-20s\n",
			    (timestamp-start)/NANOSEC,
			    (timestamp-start)%NANOSEC/1000,
			    pid,
			    "gc",
			    (timestamp-self->gc_start)/MICROSEC,
			    ((timestamp-self->gc_start)%MICROSEC)/1000,
			    "-",
			    strtok("-","?"));
			self->gc_start = 0;
		}



mysql
----

sudo dtrace -Z -n 'mysql*:::*row-done{ trace(arg0); trace(arg1) }'
